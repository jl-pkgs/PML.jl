# Calibration for site

Calibrate PMLV2 model using FLUXNET data

> US Twt (CRO, 2009)

```{julia}
using PenmanMonteithLeuning, Ipaper

df_out, df, _par = deserialize(file_FLUXNET_CRO_USTwt)
```

```{julia}
_par = (α=0.03265625, η=0.069296875, g1=9.552734375,
  VCmax25=17.671875, VPDmin=1.21515625, VPDmax=3.5, D0=0.6541015625,
  kQ=0.10114375, kA=0.89921875, S_sls=0.01015625, fER0=0.152734375, hc=0.5)

par = Param_PMLV2(; _par..., hc=0.5)
df.GPP_obs = df.GPPobs
df.ET_obs = df.ETobs
```

## 1.1 模型参数率定
```{julia}
parNames = [
  :α, :η, :g1, :VCmax25, :VPDmin, :VPDmax, :D0, :kQ, :kA, :S_sls, :fER0 # :hc
]

theta, goal, flag = ModelCalib(df, par0, parNames)
df_out = PMLV2_sites(df; par=theta2par(theta, parNames))
df_out[1:10, :]
```


## 1.2 拟合优度
```{julia}
gof = [
  (; var="ET", GOF(df.ET_obs, df_out.ET)...),
  (; var="GPP", GOF(df.GPP_obs, df_out.GPP)...)] |> DataFrame
DataFrame(gof)
```

## 1.3 绘图

```{julia}
using Plots
gr(framestyle=:box, titlefontsize=12)
t = df.date
inds = 1:46*1

function plot_var(var; label=string(var), title=string(var),
  data=df_out, scale=1, kw...)
  plot(t[inds], data[inds, var] * scale; label, title, kw...)
end
function plot_var!(p, var; label=string(var),
  data=df_out, kw...)
  plot!(p, t[inds], data[inds, var]; label, kw...)
end

p_et = plot(title="ET components (mm/d)")
plot_var!(p_et, :Ec)
plot_var!(p_et, :Es)
plot_var!(p_et, :Ei)
plot_var!(p_et, :ETobs; data=df, label="ET_obs", color=:black)

p_gpp = plot_var(:GPP; title="GPP (gC m-2 d-1)", label="GPP")
plot_var!(p_gpp, :GPPobs; data=df, label="GPP_obs", color=:black)

plot(
  p_et, p_gpp,
  plot_var(:Eeq; title="Eeq (mm/d)", label="Eeq"),
  plot_var(:Gc_w; title="Conductance (m s-1)", label="Gc"),
  plot_var(:fval_soil; title="β_soil", label="β_soil"),
  plot_var(:VPD; data=df, scale=-1, title="-VPD (kPa)", label="-VPD"),
  plot_var(:Pi; title="P - Ei (mm/d)"),
  plot_var(:Es_eq; title="Es_eq (mm/d)"),
  size=(800, 700),
  layout=(4, 2),
)
```
